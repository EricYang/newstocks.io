"use strict";var getUrlParameter=function(e){for(var t,n=window.location.search.substring(1).split("&"),i=0;i<n.length;i++)if((t=n[i].split("="))[0]===e)return void 0===t[1]||decodeURIComponent(t[1])},dateToString=(e,t="")=>e instanceof Date?e.toISOString().replace("-",t).split("T")[0].replace("-",t).substr(0,10):e,takePart2=(e,t,n)=>{for(var i=e.slice(Math.max(e.length-t,0)),r=[],a=t/n,o=0;o<n;o++){r[o]=[];for(var s=0;s<a;s++)r[o].push(i.shift())}for(o in r)r[o]=(r[o].reduce((e,t)=>e+t)/r[o].length).toFixed(2);return r},checkRise=i=>{var e,r=0,a=0,o="-";return i.map((e,t,n)=>{t+1<=i.length&&(e>n[t+1]&&(a+=1,t==i.length-2&&(o="down")),e<n[t+1]&&(r+=1,t==i.length-2&&(o="rise")))}),e=Number((i[i.length-1]-i[0])/i[0]*100).toFixed(2),[r,a,o,e]};function getDirectionByXmin(e,t){e.slice(Math.max(e.length-t,0)).reduce((e,t)=>e+t);var n=checkRise(takePart2(e,t,5)),i=n[0]-n[1],e=n[2],t="➔";return 4==i?t="⬆":2==i?t="rise"==e?"➚":"↗":-2==i?t="down"==e?"➘":"↘":-4==i&&(t="⬇"),n[3]+" % "+t}angular.module("myApp").controller("newstocksCtrl",["$scope","$rootScope","modal","cfpLoadingBar","webService",function(s,e,a,t,r){s.titles=[{id:"news",name:"新聞稿",visible:!1,type:"news"},{id:"wiki",name:"維基",visible:!1,type:"wiki"},{id:"rise",name:"漲跌",visible:!0,type:"percentage"},{id:"best_time",name:"最佳時機",visible:!0,type:"percentage"},{id:"range_low_current",name:"低x現價差",visible:!1,type:"percentage"},{id:"range_high_current",name:"高x現價差",visible:!1,type:"percentage"},{id:"range_high_open",name:"高x昨價差",visible:!1,type:"percentage"},{id:"current_price",name:"股價",visible:!0,type:"number"},{id:"volumn",name:"成交量",visible:!0,type:"number"},{id:"id",name:"代號",visible:!0,type:"number"},{id:"name",name:"名字",visible:!0,type:"string"},{id:"price5m-1h",name:"5分鐘圖/1h",visible:!1,type:"chart",chartType:"5m-1h",interval:1},{id:"price5m-2h",name:"5分鐘圖/2h",visible:!1,type:"chart",chartType:"5m-2h",interval:5},{id:"volumn30m",name:"30分鐘成交量",visible:!1,type:"chart",chartType:"30m",interval:1},{id:"min60",name:"1小時漲幅",visible:!1,type:"number"},{id:"min20",name:"20分鐘漲幅",visible:!1,type:"number"},{id:"min10",name:"10分鐘漲幅",visible:!1,type:"number"},{id:"volumn30",name:"30分鐘內量增",visible:!1,type:"number"},{id:"volumn10",name:"10分鐘內量增",visible:!1,type:"number"},{id:"volumn1",name:"1分鐘內量增",visible:!1,type:"number"},{id:"yest_avg",name:"昨日均價",visible:!1,type:"number"},{id:"current_avg",name:"今日均價",visible:!1,type:"number"},{id:"remark",name:"備註",visible:!0,type:"string"},{id:"low",name:"日最低",visible:!1,type:"number"},{id:"high",name:"日最高",visible:!1,type:"number"}],s.getNumber=function(e){return parseInt(e[s.sort.column])},s.remark=[],s.sort={column:"rise",descending:!0},s.editKey="id",s.partOfTime=0,s.changeSorting=function(e){var t=s.sort;t.column==e?t.descending=!t.descending:(t.column=e,t.descending=!1)},s.setTitle=n=>{s.titles.map((e,t)=>{n.id==e.id&&(s.titles[t].visible=!s.titles[t].visible)})},s.getAnnouncementJson=function(){var o=new Date;r.get("https://resource.aaa4u.info/stocks/newstocks/announcement.json",{},function(e){var t,n,i,r=[],a=e.data;for(t in a)a[t]&&(i=a[t][1].split("/"),n=Number(i[1]),i=Number(i[2]),o.getUTCMonth()+1<=n&&o.getUTCDate()<=i&&(i="("+a[t][3]+" "+a[t][2]+" "+a[t][4]+")",r.push(i),-1!=s.ids.indexOf(a[t][3])&&(s.remark[a[t][3]]=a[t][4])));s.announcement=r})},s.findHistVoulumn=e=>{var n=e.volume,i=e.price,r=(e.date,[]),a=0;return i.map((e,t)=>{i[t+1]&&7<=(i[t+1]-e)/e*100&&(r.push(n[t+1]),t=Number(n[t+1].replace(/,/g,"")),a+=t)}),a=Math.floor(a/r.length/1e3),[Math.floor(.4*a),Math.floor(.8*a),a]},s.handleHist=function(e){s.thenewstocks=[];var t,n=dateHandler.dateToStr(s.dt,"/",!0);for(t in e)if(e[t]){var i=e[t].date.indexOf(n);-1==(i=-1==i?e[t].price.length-1:i)&&(i=0),1<=e[t].price.length&&i<=30&&s.thenewstocks.push(t);for(var r=0;r<i;r++)e[t].max||(e[t].max=0),e[t].low||(e[t].low=1e7),e[t].max<Number(e[t].price[r])&&(e[t].max=Number(e[t].price[r])),e[t].low>Number(e[t].price[r])&&(e[t].low=Number(e[t].price[r]));e[t].gap_volumn=s.findHistVoulumn(e[t])}s.hist=e},s.getIndividualWiki=function(t,n){console.log(t);let i;r.get("https://api.aaa4u.info/public/stocks/wiki/"+t,{},function(e){s.dt.getMonth();e.data&&(i=e.data,s.origindata[t].wiki=i),n&&n(i)})},s.showNews=t=>{var e;s.origindata[t].news?(e={name:"新聞稿",array:s.origindata[t].news},a.newModal("md",e,()=>{})):s.getIndividualNews(t,e=>{e={name:"新聞稿",array:s.origindata[t].news},a.newModal("md",e,()=>{})})},s.showWiki=t=>{var e;s.origindata[t].wiki?(e={name:"維基百科",text:s.origindata[t].wiki},a.newModal("md",e,()=>{})):s.getIndividualWiki(t,e=>{e={name:"維基百科",text:s.origindata[t].wiki},a.newModal("md",e,()=>{})})},s.getIndividualNews=function(n,i){console.log(n),r.get("https://api.aaa4u.info/public/newstocks/news/"+n,{},function(e){var t;s.dt.getMonth();e.data&&(e=e.data,t=[],e.map(e=>{new Date(e.date).getMonth()==s.dt.getMonth()&&(e.date=dateHandler.dateToStr(new Date(e.date),"/",!1,"m/d"),t.push(e))}),s.origindata[n].news=t),i&&i(t)})},s.getHistJson=function(t){r.get("https://resource.aaa4u.info/stocks/newstockHist.json",{},function(e){s.handleHist(e),t&&t()})},s.setChart=(e,t,n,i)=>{s.name_chart=t,s.desc_chart=n,s.data_chart=e,s.labels_chart=[];var r=(new Date).getTime();e.map((e,t)=>{t=new Date(r-6e4*i*t);s.labels_chart.push(t.getHours()+":"+t.getMinutes())});e={name_chart:t,desc_chart:n,data_chart:e,labels_chart:s.labels_chart.reverse()};a.newModal("lg",e,()=>{})},s.getTimePartNumber=()=>{new Date;var e=(new Date).getHours();return 9==e?0:10<=e&&e<=12?1:2},s.init=()=>{s.handleHist(s.hist),s.getRemindData(()=>{s.getData()})},s.getRemindData=n=>{var e=dateToString(s.dt,"-");r.get("https://resource.aaa4u.info/stocks/newstocks/"+e+"-remind.json",{},function(e){if("error"!=(s.reminddata=e)&&e)for(var t in e)s.remark[t]=Object.values(e[t]).join(",");n&&n()})},s.deleteTimer=()=>{s.timer&&(window.clearInterval(s.timer),s.timer=null)},s.ids=[],s.hasInit=!1,s.getData=()=>{var n=dateToString(s.dt,"-");console.log(n),s.partOfTime=s.getTimePartNumber(),r.get("https://resource.aaa4u.info/stocks/newstocks/"+n+".json",{},function(e){if("error"!=e&&e){s.alldata=s.tidy(e),s.origindata=e;const t=new Date;e=t.getHours();!s.timer&&9<=e&&e<=15&&(s.timer=window.setInterval(()=>{s.init()},6e4)),dateToString(t,"-")!==n&&s.deleteTimer()}else s.deleteTimer()})};s.tidy=o=>{var e=Object.keys(o).map(n=>{s.hasInit||s.ids.push(n);var e=o[n].volumn_30mins,t=e[e.length-1]-e[0],i=e[e.length-1]-e[e.length-10],r=e[e.length-1]-e[e.length-2],e=JSON.parse(JSON.stringify(o[n].price));e.sort(function(e,t){return e-t});e=e.shift();o[n].low=e,o[n].open_price=o[n].price[0],o[n].remark=s.remark[n]||"",o[n].current_price=o[n].price[o[n].price.length-1],o[n].price10=o[n].price.slice(o[n].price.length-10),o[n]["price5m-1h"]=takePart2(o[n].price,60,12),o[n]["price5m-2h"]=takePart2(o[n].price,120,24),o[n].volumn30m=o[n].volumn_30mins.map((e,t)=>0!=t?(e-o[n].volumn_30mins[t-1])/1e3:0),o[n].volumn=Number(o[n].volumn)/1e3,o[n].volumn30=t/1e3,o[n].volumn10=i/1e3,o[n].volumn1=r/1e3,o[n].min10=getDirectionByXmin(o[n].price,10),o[n].min20=getDirectionByXmin(o[n].price,20),o[n].min60=getDirectionByXmin(o[n].price,60),o[n].range_low_current=(o[n].current_price-e)/e*100,o[n].range_high_current=(o[n].high-o[n].current_price)/o[n].high*100,o[n].range_high_open=(o[n].high-o[n].open_price)/o[n].high*100,o[n].rise=(o[n].current_price-o[n].yest_avg)/o[n].yest_avg*100,o[n].best_time=8*(o[n].range_low_current-o[n].rise);let a=.3;15<=o[n].current_price&&(a=1),60<=o[n].current_price&&(a=2),150<=o[n].current_price&&(a=3),250<=o[n].current_price&&(a=4),400<=o[n].current_price&&(a=5),800<=o[n].current_price&&(a=6);i=Number(o[n].min60.split(" ")[0]),Number(o[n].min20.split(" ")[0]),r=Number(o[n].min10.split(" ")[0]),e=r*(o[n].volumn10*a/2);return o[n].best_time+=7*i,o[n].best_time+=e,3<=o[n].range_high_current&&o[n].range_high_current<4.2&&9<=o[n].range_high_open&&0<r?o[n].best_time+=40:o[n].range_high_current<2?o[n].best_time+=20:o[n].range_high_current<3&&(o[n].best_time+=10),""!=o[n].remark&&(o[n].best_time+=10),s.hist&&s.hist[n]&&(o[n].high>=s.hist[n].max&&(o[n].best_time+=20,o[n].remark="*創新高 \n"+o[n].remark),o[n].volumn>=s.hist[n].gap_volumn[s.partOfTime]&&(o[n].best_time+=15,o[n].remark="*創新量 \n"+o[n].remark)),9<=o[n].range_high_open&&o[n].range_high_current<=4&&o[n].current_price>o[n].current_avg&&(o[n].remark="!注意股:今日起漲10% \n"+o[n].remark),(o[n].rise<0||o[n].current_avg>o[n].current_price)&&(o[n].best_time=0),o[n].volumn<=10&&(o[n].notShow=!0),o[n]});return 0<s.ids.length&&(s.hasInit=!0),s.announcement||s.getAnnouncementJson(),e},s.getHistJson(()=>{s.init()}),s.today=function(){s.dt=new Date},s.today(),s.clear=function(){s.dt=null},s.popup1={opened:!1},s.open1=function(){s.popup1.opened=!0},s.dateOptions={dateDisabled:function(e){var t=e.date;return"day"===e.mode&&(0===t.getDay()||6===t.getDay())},formatYear:"yy",maxDate:new Date,minDate:new Date("2021/05/01"),startingDay:1},s.$watch("dt",()=>{s.init()})}]).controller("newstockCtrl",["$scope","$stateParams","$rootScope","modal","cfpLoadingBar","webService",function(e,t,n,i,r,a){e.id=Number(t.id)}]);